name: Update Repository

# Security note: Both workflow_dispatch inputs and repository_dispatch payloads
# are treated as untrusted. All inputs are validated by scripts/update-repo.sh
# via scripts/lib/validation.sh. The repository_dispatch event can be triggered
# by anyone with write access to the repository.
#
on:
  workflow_dispatch:
    inputs:
      versions:
        description: 'Packages to update (e.g., "keystone-cli" or "keystone-cli:0.1.9"). Leave empty for all packages.'
        required: false
        type: string
  repository_dispatch:
    types: [release-published]

concurrency:
  group: update-repo
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout apt repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Install yq
        run: sudo snap install yq

      - name: Build version arguments
        id: args
        env:
          GH_TOKEN: ${{ github.token }}
          # Pass untrusted inputs via env vars to prevent script injection
          INPUT_VERSIONS: ${{ inputs.versions }}
          PAYLOAD_VERSIONS: ${{ github.event.client_payload.versions }}
        run: |
          if [[ -n "${INPUT_VERSIONS}" ]]; then
            # Use workflow_dispatch input
            echo "versions=${INPUT_VERSIONS}" >> "${GITHUB_OUTPUT}"
          elif [[ -n "${PAYLOAD_VERSIONS}" ]]; then
            # Use repository_dispatch payload
            echo "versions=${PAYLOAD_VERSIONS}" >> "${GITHUB_OUTPUT}"
          else
            # Fetch latest for all packages
            echo "versions=" >> "${GITHUB_OUTPUT}"
          fi

      - name: Update repository
        env:
          GH_TOKEN: ${{ github.token }}
          VERSIONS: ${{ steps.args.outputs.versions }}
        run: |
          # shellcheck disable=SC2086
          # $VERSIONS must word-split to pass multiple package specs as separate args
          ./scripts/update-repo.sh ${VERSIONS}

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          FINGERPRINT=$(gpg --list-secret-keys --with-colons | grep fpr | head -1 | cut -d: -f10)
          echo "${FINGERPRINT}:6:" | gpg --import-ownertrust

      - name: Sign Release file
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: ./scripts/sign-release.sh

      - name: Remove .gitkeep files
        run: find dists -name ".gitkeep" -delete

      - name: Create PR with changes
        env:
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
          VERSIONS: ${{ steps.args.outputs.versions }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: ./scripts/create-update-pr.sh
